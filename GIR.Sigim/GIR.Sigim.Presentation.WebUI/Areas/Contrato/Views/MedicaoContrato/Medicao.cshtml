@model GIR.Sigim.Presentation.WebUI.Areas.Contrato.ViewModel.MedicaoContratoMedicaoViewModel

@{
    ViewBag.Title = "Medição";
}

@Html.Partial("_NotificationMessagesPartial")
<div class="row">
    <article class="col-sm-12 col-md-12 col-lg-8 sortable-grid ui-sortable centerBox">
        <div class="jarviswidget" id="wid-id-1" data-widget-editbutton="false" data-widget-custombutton="false">
            <header>
                <span class="widget-icon"><i class="fa fa-cog"></i></span>
                <h2>@ViewBag.Title</h2>
            </header>
            <div>
                <div class="widget-body no-padding">
                    @using (Ajax.BeginForm(
                            "Medicao",
                            "MedicaoContrato",
                            null,
                            new AjaxOptions() { InsertionMode = InsertionMode.Replace, HttpMethod = "POST", OnSuccess = "refresh", UpdateTargetId = "notificationMessages" },
                            new { @id = "formMedicao", @class = "smart-form client-form", @novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()

                        @Html.HiddenFor(m => m.Contrato.CentroCusto.Codigo)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacao.RetencaoContratual)
                        @Html.HiddenFor(m => m.Contrato.ContratadoId)
                        @Html.HiddenFor(m => m.Contrato.TipoContrato)


                        @Html.HiddenFor(m => m.JsonListaRetificacaoProvisao)
                        @Html.HiddenFor(m => m.DiasMedicaoParametrosContrato)
                        @Html.HiddenFor(m => m.DiasPagamentoParametrosContrato)
                        @Html.HiddenFor(m => m.EhSituacaoAguardandoAprovacao)
                        @Html.HiddenFor(m => m.EhSituacaoAguardandoLiberacao)
                        @Html.HiddenFor(m => m.EhSituacaoLiberado)
                        @Html.HiddenFor(m => m.DataLimiteMedicao)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.SequencialItem)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoId)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.RetencaoItem)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.BaseRetencaoItem)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)

                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.ValorPendente)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.QuantidadePendente)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronogramaId)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.SequencialCronograma)
                        @Html.HiddenFor(m => m.ContratoRetificacaoItemMedicao.Id)
                        
                        <div class="panel-group smart-accordion-default" id="accordion">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseContrato" class="">
                                            <i class="fa fa-lg fa-angle-down pull-right"></i>
                                            <i class="fa fa-lg fa-angle-up pull-right"></i>
                                            Contrato
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapseContrato" class="panel-collapse collapse in">
                                    <div class="panel-body no-padding">
                                        <fieldset>
                                            <div class="row">
                                                <section class="col col-6">
                                                    <label class="label">Contrato</label>
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoId, new { @class="readonly", @readonly = "" })  
                                                    </label>
                                                </section>
                                                <section class="col col-6">
                                                    <label class="label">Descrição Contrato</label>
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.Contrato.ContratoDescricao.Descricao, new { @class="readonly", @readonly = "" })  
                                                    </label>
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-6">
                                                    @Html.LabelFor(m => m.Contrato.CentroCusto.CentroCustoDescricao, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.Contrato.CentroCusto.CentroCustoDescricao, new {@class="readonly", @readonly = "" })  
                                                    </label>
                                                </section> 
                                                <section class="col col-6">
                                                    @Html.LabelFor(m => m.RetencaoContratual, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.RetencaoContratual,"{0:F5}", new { @readonly = "", @class = "text-right decimal-5-casas readonly" })  
                                                    </label>
                                                </section> 
                                            </div>
                                            <div class="row">
                                                <section class="col col-6">
                                                    <label class="label">Contratado</label>
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.Contrato.Contratado.Nome, new {@class="readonly", @readonly = "" })  
                                                    </label>
                                                </section>
                                                <section class="col col-6">
                                                @{
                                                    if (Model.Contrato.Contratado.TipoPessoa == "J")
                                                    {
                                                        @Html.LabelFor(m => m.Contrato.Contratado.PessoaJuridica.Cnpj, new { @class = "label" })
                                                        <label class="input">
                                                            @Html.TextBoxFor(m => m.Contrato.Contratado.PessoaJuridica.Cnpj , new {@class="readonly", @readonly = "" })  
                                                        </label>
                                                    }
                                                    else
                                                    {
                                                        @Html.LabelFor(m => m.Contrato.Contratado.PessoaFisica.Cpf, new { @class = "label" })
                                                        <label class="input">
                                                            @Html.TextBoxFor(m => m.Contrato.Contratado.PessoaFisica.Cpf, new {@class="readonly", @readonly = "" })  
                                                        </label>
                                                    }
                                                }
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-12">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId, Model.ListaServicoContratoRetificacaoItem, string.Empty ,new {@class="required", @novalidate = "novalidate" })          
                                                        <i></i>
                                                    </label>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId, "", new { @id = Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId) + "_ValidationMessage", @class = "note note-error" })
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-12">
                                                    <label class="label">Complemento</label>
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ComplementoDescricao, new {@class="readonly", @readonly = "" })
                                                    </label>
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-6">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.DescricaoNaturezaItem, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.DescricaoNaturezaItem, new { @class = "readonly", @readonly = "" })
                                                    </label>
                                                </section>
                                                <section class="col col-2">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.Servico.SiglaUnidadeMedida, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.Servico.SiglaUnidadeMedida, new { @class = "readonly", @readonly = "" })
                                                    </label>
                                                </section>
                                                <section class="col col-4">
                                                    <label class="label">Valor ítem</label>
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem, "{0:F2}", new { @readonly = "", @class = "text-right decimal-2-casas readonly" })
                                                    </label>
                                                </section>
                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseDadosNota" class="collapsed">
                                            <i class="fa fa-lg fa-angle-down pull-right"></i>
                                            <i class="fa fa-lg fa-angle-up pull-right"></i>
                                            Dados da Nota
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapseDadosNota" class="panel-collapse collapse" style="height: 0px;">
                                    <div class="panel-body no-padding">
                                        <fieldset>
                                            <div class="row">
                                                <section class="col col-2">
                                                    @Html.LabelFor(m => m.ListaTipoDocumento, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.TipoDocumentoId, Model.ListaTipoDocumento, string.Empty, new { @class = "required", @required = true })  
                                                        <i></i>
                                                    </label>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.TipoDocumentoId, "", new { @class = "note note-error" })
                                                </section>
                                                <section class="col col-3">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento, new { @class = "required", @maxlength = "10", @required = true })  
                                                        <script type="text/javascript">
                                                            $(document).ready(function () {
                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").on("change", function () {
                                                                    validaNumeroDocumento();
                                                                });
                                                            });
                                                        </script>
                                                    </label>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento, "", new { @class = "note note-error" })
                                                </section>
                                                <section class="col col-3">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao, new { @class = "label" })
                                                    <label class="input">
                                                        <i class="icon-append fa fa-calendar"></i>
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao, "{0:dd/MM/yyyy}", new { @class = "required", @required = true })  
                                                        <script type="text/javascript">
                                                            $(document).ready(function () {
                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").on("change", function () {
                                                                    validaNumeroDocumento();
                                                                });
                                                            });
                                                        </script>
                                                    </label>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao, "Informe uma data válida.", new { @class = "note note-error" })
                                                </section>
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento, new { @class = "label" })
                                                    <div class="input-group">
                                                        <label class="input">
                                                            <i class="icon-append fa fa-calendar"></i>
                                                            @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento, "{0:dd/MM/yyyy}", new { @class = "required", @required = true })  
                                                            <script type="text/javascript">
                                                                $(document).ready(function () {
                                                                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)").on("change", function () {
                                                                        var retorno = validaDataVencimento();
                                                                        if (retorno == false) {
                                                                            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)").val("");
                                                                        }
                                                                    });
                                                                });
                                                            </script>
                                                        </label>
                                                        <a data-toggle="modal" href="#VisualizarMedicao_ModalPanel" class="button-icon input-group-addon"><i class="fa fa-lg fa-search"></i></a>
                                                        <div class="modal fade" id="VisualizarMedicao_ModalPanel" tabindex="-1" role="dialog">
                                                            <div class="modal-dialog" style="width:100%;">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                                            &times;
                                                                        </button>
                                                                        <h4 class="modal-title">
                                                                            Visualiza medição
                                                                        </h4>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <div class="table-responsive" style="min-height: 115px; border: 1px solid #ddd; margin-bottom: 13px; overflow-x: auto;">
                                                                            <table id="tableLstVisMedicao" class="table table-bordered table-striped table-condensed table-hover dataTable">
                                                                                <thead>
                                                                                </thead>
                                                                                <tbody>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
							                                        </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento, "Informe uma data válida.", new { @class = "note note-error" })
                                                </section>
                                                <script type="text/javascript">
                                                    $(document).ready(function () {
                                                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)').datepicker({
                                                            prevText: '<i class="fa fa-chevron-left"></i>',
                                                            nextText: '<i class="fa fa-chevron-right"></i>',
                                                            changeMonth: true,
                                                            changeYear: true,
                                                            onClose: function (selectedDate) {
                                                                if ($(this).valid()) {
                                                                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)').datepicker('option', 'minDate', selectedDate);
                                                                }
                                                                else {
                                                                    $(this).val("");
                                                                }
                                                            }
                                                        });

                                                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)').datepicker({
                                                            prevText: '<i class="fa fa-chevron-left"></i>',
                                                            nextText: '<i class="fa fa-chevron-right"></i>',
                                                            changeMonth: true,
                                                            changeYear: true,
                                                            minDate: '#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)',
                                                            onClose: function (selectedDate) {
                                                                if ($(this).valid()) {
                                                                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)').datepicker('option', 'maxDate', selectedDate);
                                                                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)').datepicker('option', 'maxDate', selectedDate);
                                                                }
                                                                else {
                                                                    $(this).val("");
                                                                }
                                                            }
                                                        });
                                                    });
                                                </script>
                                            </div>
                                            <div class="row">
                                                <section class="col col-12">
                                                    @Html.LabelFor(m => m.ListaMultiFornecedor, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId, Model.ListaMultiFornecedor, string.Empty)  
                                                        <i></i>
                                                        <script type="text/javascript">
                                                            $(document).ready(function () {
                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId)").on("change", function () {
                                                                    validaNumeroDocumento();
                                                                });
                                                            });
                                                        </script>

                                                    </label>
                                                </section>
                                            </div>
                                        </fieldset>
                                        <h5 style="padding-left :15px;">
                                            Dados Gerais
                                        </h5>
                                        <fieldset>
                                            <div class="row">
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaTipoCompra, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.TipoCompraCodigo, Model.ListaTipoCompra, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaCifFob, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.CifFobId, Model.ListaCifFob, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaNaturezaOperacao, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.NaturezaOperacaoCodigo, Model.ListaNaturezaOperacao, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaSerieNF, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.SerieNFId, Model.ListaSerieNF, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaCST, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.CSTCodigo, Model.ListaCST, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                                <section class="col col-4">
                                                    @Html.LabelFor(m => m.ListaCodigoContribuicao, new { @class = "label" })
                                                    <label class="select">
                                                        @Html.DropDownListFor(m => m.ContratoRetificacaoItemMedicao.CodigoContribuicaoCodigo, Model.ListaCodigoContribuicao, string.Empty)  
                                                        <i></i>
                                                    </label>
                                                </section>
                                            </div>
                                            <div class="row">
                                                <section class="col col-12">
                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.CodigoBarras, new { @class = "label" })
                                                    <label class="input">
                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.CodigoBarras, new { @maxlength = "50" })  
                                                    </label>
                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.CodigoBarras, "", new { @class = "note note-error" })
                                                </section>
                                            </div>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseMedicao" class="collapsed" id="accordionMedicao">
                                            <i class="fa fa-lg fa-angle-down pull-right"></i>
                                            <i class="fa fa-lg fa-angle-up pull-right"></i>
                                            Medição
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapseMedicao" class="panel-collapse collapse" style="height: 0px;">
                                    <div class="panel-body no-padding">
                                        <fieldset>

                                            <div class="widget-body">
						                        <hr class="simple">
						
						                        <ul id="tabMedicao" class="nav nav-tabs bordered">
							                        <li class="active">
								                        <a href="#AbaProvisionamento" data-toggle="tab" id="AbaProvisionamentoId">Provisionamento</a>
							                        </li>
							                        <li class="">
								                        <a href="#AbaMedicao" data-toggle="tab" id="AbaMedicaoId">Dados da medição</a>
							                        </li>
						                        </ul>
						                        <div id="myTabContent1" class="tab-content padding-10">
							                        <div class="tab-pane fade active in" id="AbaProvisionamento">
                                                        <div class="table-responsive" style="min-height: 115px; border: 1px solid #ddd; margin-bottom: 13px; overflow-x: auto;">
                                                            <table id="tableItens" class="table table-bordered table-striped table-condensed table-hover dataTable">
                                                                <thead>
                                                                    <tr role="row">
                                                                        <th style="min-width: 65px;">Seq</th>
                                                                        <th>Evento</th>
                                                                        <th class="text-center">Data</th>
                                                                        <th class="text-right">Quantidade</th>
                                                                        <th class="text-right">Quantidade medida</th>
                                                                        <th class="text-right">Quantidade pendente</th>
                                                                        <th class="text-right">Valor</th>
                                                                        <th class="text-right">Valor medido</th>
                                                                        <th class="text-right">Valor pendente</th>
                                                                        <th class="text-right">Pagamento antecipado</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                </tbody>
                                                            </table>
                                                        </div>
							                        </div>
							                        <div class="tab-pane fade" id="AbaMedicao">
                                                        <fieldset>
                                                            <div class="row">
                                                                <section class="col col-4">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao, new { @class = "label" })
                                                                    <div class="input-group">
                                                                        <label class="input">
                                                                            <i class="icon-append fa fa-calendar"></i>
                                                                            @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao, "{0:dd/MM/yyyy}", new { @class = "required", @required = true })  
                                                                            <script type="text/javascript">
                                                                                $(document).ready(function () {
                                                                                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").on("change", function () {
                                                                                        validaDataMedicao();
                                                                                    });
                                                                                });
                                                                            </script>
                                                                        </label>
                                                                        <a data-toggle="modal" href="#PesquisarMedicao_ModalPanel" class="button-icon input-group-addon"><i class="fa fa-lg fa-search"></i></a>
                                                                        <div class="modal fade" id="PesquisarMedicao_ModalPanel" tabindex="-1" role="dialog">
                                                                            <div class="modal-dialog">
                                                                                <div class="modal-content">
                                                                                    <div class="modal-header">
                                                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                                                            &times;
                                                                                        </button>
                                                                                        <h4 class="modal-title">
                                                                                            Seleciona medição
                                                                                        </h4>
                                                                                    </div>
                                                                                    <div class="modal-body">
                                                                                        <div class="table-responsive" style="min-height: 115px; border: 1px solid #ddd; margin-bottom: 13px; overflow-x: auto;">
                                                                                            <table id="tableLstMedicao" class="table table-bordered table-striped table-condensed table-hover dataTable">
                                                                                                <thead>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="modal-footer">
							                                                        </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao, "Informe uma data válida.", new { @class = "note note-error" })
                                                                </section>
                                                                <script type="text/javascript">
                                                                    $(document).ready(function () {
                                                                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)').datepicker({
                                                                            prevText: '<i class="fa fa-chevron-left"></i>',
                                                                            nextText: '<i class="fa fa-chevron-right"></i>',
                                                                            changeMonth: true,
                                                                            changeYear: true,
                                                                            maxDate: '#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)',
                                                                            onClose: function (selectedDate) {
                                                                                if (!$(this).valid()) {
                                                                                    $(this).val("");
                                                                                }
                                                                            }
                                                                        });
                                                                    });
                                                                </script>
                                                                <section class="col col-4">
                                                                    @Html.LabelFor(m => m.PrecoUnitario, new { @class = "label" })
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.PrecoUnitario, "{0:F5}", new { @readonly = "", @class = "text-right decimal-5-casas readonly" })
                                                                    </label>
                                                                </section>
                                                            </div>
                                                            <div class="row">
                                                                <section class="col col-4">
                                                                    <label class="label">Valor contratado</label>
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Valor, "{0:F2}", new { @readonly = "", @class = "text-right decimal-2-casas readonly" })
                                                                    </label>
                                                                </section>
                                                                <section class="col col-4">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.Valor, new { @class = "label" })
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.Valor, "{0:F2}", new { @class = "text-right decimal-2-casas required", @required = true })
                                                                        <script type="text/javascript">
                                                                            $(document).ready(function () {
                                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").on("change", function () {
                                                                                    validaValorMedicaoAtual();
                                                                                });
                                                                            });
                                                                        </script>
                                                                    </label>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.Valor, "", new { @class = "note note-error" })
                                                                </section>
                                                            </div>
                                                            <div class="row">
                                                                <section class="col col-4">
                                                                    <label class="label">Quantidade contratada</label>
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Quantidade, "{0:F7}", new { @readonly = "", @class = "text-right decimal-7-casas readonly" })
                                                                    </label>
                                                                </section>
                                                                <section class="col col-4">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.Quantidade, new { @class = "label" })
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.Quantidade, "{0:F7}", new { @class = "text-right decimal-7-casas required", @required = true })
                                                                        <script type="text/javascript">
                                                                            $(document).ready(function () {
                                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").on("change", function () {
                                                                                    validaQuantidadeMedicaoAtual();
                                                                                });
                                                                            });
                                                                        </script>
                                                                    </label>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.Quantidade, "", new { @class = "note note-error" })
                                                                </section>
                                                                <section class="col col-4">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.Desconto, new { @class = "label" })
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.Desconto, "{0:F2}", new { @class = "text-right decimal-2-casas" })
                                                                        <script type="text/javascript">
                                                                            $(document).ready(function () {
                                                                                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").on("change", function () {
                                                                                    validaDesconto();
                                                                                });
                                                                            });
                                                                        </script>
                                                                    </label>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.Desconto, "", new { @class = "note note-error" })
                                                                </section>
                                                            </div>
                                                            <div class="row">
                                                                <section class="col col-6">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.Observacao, new { @class = "label" })
                                                                    <label class="textarea">
                                                                        @Html.TextAreaFor(m => m.ContratoRetificacaoItemMedicao.Observacao, new { rows = 5, style = "height:104px;" })
                                                                    </label>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.Observacao, "", new { @class = "note note-error" })
                                                                </section>
                                                                <section class="col col-6">
                                                                    @Html.LabelFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto, new { @class = "label" })
                                                                    <label class="input">
                                                                        @Html.TextBoxFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto)
                                                                    </label>
                                                                    @Html.ValidationMessageFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto, "", new { @class = "note note-error" })
                                                                </section>
                                                            </div>
                                                        </fieldset>
							                        </div>
						                        </div>
					                        </div>
                                        </fieldset>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <footer>
                            @Html.ActionLink("Voltar", "Index", null, null, new { @class = "btn btn-primary" })
                            @{
                                string disableBtnCancelar = string.Empty;
                                if (!Model.PodeCancelar)
                                {
                                    disableBtnCancelar = "disabled";
                                }
                            }
                            <a data-toggle="modal" id="btnCancelar" class="btn btn-danger @disableBtnCancelar">Cancelar</a>

                            @{
                                var url = Url.Action("Imprimir","MedicaoContrato");
                            }
                            @Html.EditorFor(m => m.PodeImprimir, "Imprimir", new { @url = url })

                            @{
                                string disableBtnSalvar = string.Empty;
                                if (!Model.PodeSalvar)
                                {
                                    disableBtnSalvar = "disabled";
                                }
                            }
                            <button id="btnSalvar" type="submit" class="btn btn-primary @disableBtnSalvar">
                                Salvar
                            </button>

                        </footer>                        
                    }
                </div>
            </div>
        </div>
    </article>
</div> 

<script type="text/javascript">
    $(document).ready(function () {
        tratarBotoes(false, false, false);

        $(document).on("showFormatoImpressaoModalPanel", function (e) {

            var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val();
            var tipoDocumentoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.TipoDocumentoId)").val();
            var numeroDocumento = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").val();
            var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();
            var contratadoId = $("#@Html.IdFor(m => m.Contrato.ContratadoId)").val();
            var multiFornecedorId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId)").val();
            var retencaoContratual = $("#@Html.IdFor(m => m.RetencaoContratual)").val();
            var valorContratadoItem = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem)").val();

            if ((multiFornecedorId != "") && (multiFornecedorId > 0)) {
                contratadoId = multiFornecedorId;
            }
            var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();

            if (contratoId == "") {
                smartAlert("Atenção", "Informe o contrato", "warning");
                e.event.preventDefault();
            }

            if (contratoId == 0) {
                smartAlert("Atenção", "Informe o contrato", "warning");
                e.event.preventDefault();
            }

            if (tipoDocumentoId == "") {
                smartAlert("Atenção", "Informe o tipo da nota", "warning");
                e.event.preventDefault();
            }
            if (tipoDocumentoId == 0) {
                smartAlert("Atenção", "Informe o tipo da nota", "warning");
                e.event.preventDefault();
            }
            if (numeroDocumento == "") {
                smartAlert("Atenção", "Informe o número da nota", "warning");
                $('#btnImprimir').prop('data-dismiss', 'modal');
                e.event.preventDefault();
            }

            if (dataEmissao == "") {
                smartAlert("Atenção", "Informe a data de emissão", "warning");
                e.event.preventDefault();
            }

            parametrosUrlImpressao += '&contratadoId=' + contratadoId;
            parametrosUrlImpressao += '&contratoId=' + contratoId;
            parametrosUrlImpressao += '&tipoDocumentoId=' + tipoDocumentoId;
            parametrosUrlImpressao += '&numeroDocumento=' + numeroDocumento;
            parametrosUrlImpressao += '&dataEmissao=' + dataEmissao;
            parametrosUrlImpressao += '&multiFornecedorId=' + multiFornecedorId;
            parametrosUrlImpressao += '&retencaoContratual=' + retencaoContratual;
            parametrosUrlImpressao += '&valorContratadoItem=' + valorContratadoItem;

        });

        $(document).on("show.bs.modal", "#PesquisarMedicao_ModalPanel", function (e) {
            var isRecuperou = false;
            var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val();
            var sequencialItem = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialItem)").val();            
            var contratoRetificacaoItemId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId)").val();

            if (contratoRetificacaoItemId == "") {                
                smartAlert("Erro", "Selecione um item !", "error");
                return e.preventDefault()
            }
            else {
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("RecuperaMedicaoPorSequencialItem", "MedicaoContrato", new { area = "Contrato" })',
                        cache: false,
                        async: false,
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify({
                            contratoId: contratoId,
                            sequencialItem: sequencialItem
                        }),
                        success: function (result) {
                            showErrorMessage(getErrorMessageContainer('@Html.NameFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)'), result.errorMessage);
                            if (result.ehRecuperou) {
                                jsonContratoRetificaoItemMedicaoArray = result.listaContratoRetificacaoItemMedicao;
                            }
                            else {
                                jsonContratoRetificaoItemMedicaoArray = null;
                            }
                            isRecuperou = result.ehRecuperou;
                        },
                        error: function (result) {
                            jsonContratoRetificaoItemMedicaoArray = null;
                        }
                    });

                    preencheLstMedicao();
            }
        });

        $(document).on("show.bs.modal", "#VisualizarMedicao_ModalPanel", function (e) {
            var isRecuperou = false;
            var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val();
            var tipoDocumentoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.TipoDocumentoId)").val();
            var numeroDocumento = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").val();
            var contratadoId = $("#@Html.IdFor(m => m.Contrato.ContratadoId)").val();
            var multiFornecedorId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId)").val();
            //if ((multiFornecedorId != "") && (multiFornecedorId > 0)) {
            //    contratadoId = multiFornecedorId;
            //}
            var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();

            if (contratoId == "") {
                smartAlert("Atenção", "Informe o contrato", "warning");
                return e.preventDefault();
            }

            if (contratoId == 0) {
                smartAlert("Atenção", "Informe o contrato", "warning");
                return e.preventDefault();
            }

            if (tipoDocumentoId == "") {
                smartAlert("Atenção", "Informe o tipo da nota", "warning");
                return e.preventDefault();
            }
            if (tipoDocumentoId == 0) {
                smartAlert("Atenção", "Informe o tipo da nota", "warning");
                return e.preventDefault();
            }
            if (numeroDocumento == "") {
                smartAlert("Atenção", "Informe o número da nota", "warning");
                return e.preventDefault();
            }

            if (dataEmissao == "") {
                smartAlert("Atenção", "Informe a data de emissão", "warning");
                return e.preventDefault();
            }

            if ((tipoDocumentoId != "") && (numeroDocumento != "")) {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("RecuperaMedicaoPorContratoDadosDaNota", "MedicaoContrato", new { area = "Contrato" })',
                        cache: false,
                        async: false,
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify({
                            contratoId: contratoId,
                            tipoDocumentoId: tipoDocumentoId,
                            numeroDocumento: numeroDocumento,
                            dataEmissao: dataEmissao,
                            contratadoId: contratadoId,
                            multiFornecedorId: multiFornecedorId
                        }),
                        success: function (result) {
                            showErrorMessage(getErrorMessageContainer('@Html.NameFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)'), result.errorMessage);
                            if (result.ehRecuperou) {
                                jsonContratoRetificaoItemMedicaoArray = result.listaContratoRetificacaoItemMedicao;
                            }
                            else {
                                jsonContratoRetificaoItemMedicaoArray = null;
                            }
                            isRecuperou = result.ehRecuperou;
                        },
                        error: function (result) {
                            jsonContratoRetificaoItemMedicaoArray = null;
                        }
                });

                preencheLstVisualizacaoMedicao();
            }
        });

        $(document).on("change", "#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId)", function () {
            recuperaContratoItem();
        });

        $(document).on("click", "#accordionMedicao", function () {
            setarAbaProvisionamento();
        });


        $("#btnCancelar").on("click", function () {
            var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val();
            var id = $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)').val();
            var isCancelou = false;

            $.ajax({
                type: 'POST',
                url: '@Url.Action("Cancelar", "MedicaoContrato")',
                cache: false,
                async: false,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    id: id,
                    contratoId: contratoId
                })
            })
            .success(function (result) {
                $('#notificationMessages').html(result.message);
                
                isCancelou = result.ehCancelou;
                if (isCancelou) {
                    smartAlert("Sucesso", result.message, "success");
                    recuperaContratoItem();
                }
                else {
                    smartAlert("Ocorreu erro na exclusão", result.message, "error");
                }
            });
        });
    });

    function refresh(mensagem) {
        onSuccess();
        // se nehuma mensagem de erro retornou, eu executo o javascript recuperaContratoItem
        if (mensagem.search('alert-danger') == -1) {
            recuperaContratoItem();
        }
    }

    function recuperaContratoItem() {
        var isRecuperou = false;
        var codigoContratoRetificacaoItem = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId)").val(); 
        var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val(); 
        $.ajax({
            type: 'POST',
            url: '@Url.Action("RecuperaContratoRetificacaoItem", "MedicaoContrato", new { Area = "Contrato" })',
            cache: false,
            async: false,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({
                contratoId: contratoId,
                contratoRetificacaoItemId: codigoContratoRetificacaoItem
            }),
            success: function (result) {
                showErrorMessage(getErrorMessageContainer('@Html.NameFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId)'), result.errorMessage);
                if (result.ehRecuperou) {
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ComplementoDescricao)').val(result.contratoRetificacaoItem.ComplementoDescricao);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.DescricaoNaturezaItem)').val(result.contratoRetificacaoItem.DescricaoNaturezaItem);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.Servico.SiglaUnidadeMedida)').val(result.contratoRetificacaoItem.Servico.SiglaUnidadeMedida);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem)').val("");
                    if (result.contratoRetificacaoItem.ValorItem != null) {
                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem)').val(roundDecimal(floatToString(result.contratoRetificacaoItem.ValorItem), 2));
                    }
                    $('#@Html.IdFor(m => m.RetencaoContratual)').val(roundDecimal(floatToString(0), 5));
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.RetencaoItem)').val("");
                    if (result.retencaoItem != null) {
                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.RetencaoItem)').val(roundDecimal(floatToString(result.contratoRetificacaoItem.RetencaoItem), 5));
                        $('#@Html.IdFor(m => m.RetencaoContratual)').val(roundDecimal(floatToString(result.contratoRetificacaoItem.RetencaoItem), 5));
                    }
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.BaseRetencaoItem)').val("");
                    if (result.contratoRetificacaoItem.BaseRetencaoItem != null) {
                        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.BaseRetencaoItem)').val(roundDecimal(floatToString(result.contratoRetificacaoItem.BaseRetencaoItem), 5));
                    }
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val(roundDecimal(floatToString(result.contratoRetificacaoItem.PrecoUnitario), 5));
                    $('#@Html.IdFor(m => m.JsonListaRetificacaoProvisao)').val(JSON.stringify(result.listaContratoRetificacaoProvisao));
                    jsonRetificaoProvisaoArray = result.listaContratoRetificacaoProvisao;
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)').val(result.ehNaturezaItemPorPrecoGlobal);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoUnitario)').val(result.ehNaturezaItemPorPrecoUnitario);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialItem)').val(result.contratoRetificacaoItem.Sequencial);
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)").val(null);
                }
                else
                {
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ComplementoDescricao)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.DescricaoNaturezaItem)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.Servico.SiglaUnidadeMedida)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.RetencaoItem)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.BaseRetencaoItem)').val("");
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val(0);
                    $('#@Html.IdFor(m => m.JsonListaRetificacaoProvisao)').val("");
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)').val(false);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoUnitario)').val(false);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialItem)').val(0);
                    jsonRetificaoProvisaoArray = "[]";
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)").val(null);
                }
                isRecuperou = result.ehRecuperou;
            },
            error: function (result) {
                showErrorMessage(getErrorMessageContainer('@Html.NameFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemId)'), result.errorMessage);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ComplementoDescricao)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.DescricaoNaturezaItem)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.Servico.SiglaUnidadeMedida)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.ValorItem)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.RetencaoItem)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.BaseRetencaoItem)').val("");
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val(0);
                $('#@Html.IdFor(m => m.JsonListaRetificacaoProvisao)').val("");
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)').val(false);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoUnitario)').val(false);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialItem)').val(0);
                jsonRetificaoProvisaoArray = "[]";
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)").val(null);
            }
        });

        fillTable();
        limpaAbaDadosMedicao();

        return isRecuperou;
    }

    function fillTable() {
        var ehNaturezaItemPorPrecoGlobal = ($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)").val() === "true");

        $("#tableItens thead").empty();
        var row = $('<tr role="row">');
        $("#tableItens thead").append(row);
        row.append($('<th style="min-width: 65px;">Seq</th>'));
        row.append($('<th>Evento</th>'));
        row.append($('<th class="text-center">Data</th>'));
        if (jsonRetificaoProvisaoArray != null) {
            if (!ehNaturezaItemPorPrecoGlobal) {
                row.append($('<th class="text-right">Quantidade</th>'));
                row.append($('<th class="text-right">Quantidade medida</th>'));
                row.append($('<th class="text-right">Quantidade pendente</th>'));
            }
        }
        else {
            row.append($('<th class="text-right">Quantidade</th>'));
            row.append($('<th class="text-right">Quantidade medida</th>'));
            row.append($('<th class="text-right">Quantidade pendente</th>'));
        }
        row.append($('<th class="text-right">Valor</th>'));
        row.append($('<th class="text-right">Valor medido</th>'));
        row.append($('<th class="text-right">Valor pendente</th>'));
        row.append($('<th class="text-center">Pagamento antecipado</th>'));
        row.append($('<tr />'));

        var totalQuantidade = 0;
        var totalQuantidadeMedida = 0;
        var totalQuantidadePendente = 0;
        var totalValor = 0;
        var totalValorMedido = 0;
        var totalValorPendente = 0;

        $("#tableItens tbody").empty();

        if (jsonRetificaoProvisaoArray != null) {
            for (var i = 0; i < jsonRetificaoProvisaoArray.length; i++) {

                Valor = jsonRetificaoProvisaoArray[i].Valor;
                ValorAdiantadoDescontado = jsonRetificaoProvisaoArray[i].ValorAdiantadoDescontado;
                if (Valor == 0) continue;
                if (ValorAdiantadoDescontado == null) ValorAdiantadoDescontado = 0;
                if ((Valor - ValorAdiantadoDescontado) <= 0) continue;


                totalQuantidade = totalQuantidade + jsonRetificaoProvisaoArray[i].Quantidade;
                totalQuantidadeMedida = totalQuantidadeMedida + jsonRetificaoProvisaoArray[i].QuantidadeTotalMedida;
                totalQuantidadePendente = totalQuantidadePendente + jsonRetificaoProvisaoArray[i].QuantidadePendente;
                totalValor = totalValor + jsonRetificaoProvisaoArray[i].Valor;
                totalValorMedido = totalValorMedido + jsonRetificaoProvisaoArray[i].ValorTotalMedido;
                totalValorPendente = totalValorPendente + jsonRetificaoProvisaoArray[i].ValorPendente;

                var row = $('<tr />')

                $("#tableItens tbody").append(row);
                row.append($('<td class="text-nowrap">' + jsonRetificaoProvisaoArray[i].ContratoRetificacaoItemCronograma.Sequencial + '</td>'));
                row.append($('<td class="text-nowrap" onclick="carregaAbaDadosMedicao(' + jsonRetificaoProvisaoArray[i].ContratoRetificacaoItemCronograma.Sequencial + ');">' + jsonRetificaoProvisaoArray[i].ContratoRetificacaoItemCronograma.Descricao + '</td>'));
                row.append($('<td class="text-center">' + new Date(parseInt(jsonRetificaoProvisaoArray[i].ContratoRetificacaoItemCronograma.DataVencimento.substr(6))).toFormatDDMMYYYY() + '</td>'));
                if (!ehNaturezaItemPorPrecoGlobal) {
                    row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].Quantidade), 7) + '</td>'));
                    row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].QuantidadeTotalMedida), 7) + '</td>'));
                    row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].QuantidadePendente), 7) + '</td>'));
                }
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].Valor), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].ValorTotalMedido), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonRetificaoProvisaoArray[i].ValorPendente), 2) + '</td>'));
                row.append($('<td class="text-center">' + jsonRetificaoProvisaoArray[i].DescricaoPagamentoAntecipado + '</td>'));
            }

            var row = $('<tr />')

            $("#tableItens tbody").append(row);
            row.append($('<td></td>'));
            row.append($('<td></td>'));
            row.append($('<td></td>'));
            if (!ehNaturezaItemPorPrecoGlobal) {
                row.append($('<td class="text-right">' + roundDecimal(floatToString(totalQuantidade), 7) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(totalQuantidadeMedida), 7) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(totalQuantidadePendente), 7) + '</td>'));
            }
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValor), 2) + '</td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorMedido), 2) + '</td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorPendente), 2) + '</td>'));
            row.append($('<td></td>'));
            var row = $('<tr />')
            $("#tableItens tbody").append(row);
        }

        setarAbaProvisionamento();

        jsonRetificaoProvisaoArray = null;
    }

    function carregaAbaDadosMedicao(sequencial) {
        jsonRetificaoProvisaoArray = JSON.parse($('#@Html.IdFor(m => m.JsonListaRetificacaoProvisao)').val());

        var ehNaturezaItemPorPrecoGlobal = ($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)").val() === "true");
        var precoUnitario = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val();

        limpaAbaDadosMedicao();

        if (jsonRetificaoProvisaoArray != null) {

            var arr = jQuery.grep(jsonRetificaoProvisaoArray, function (item, i) {
                return (item.ContratoRetificacaoItemCronograma.Sequencial == sequencial)
            });

            if (arr.length > 0) {
                var item = arr[0];
                var quantidadePendente = item.Quantidade - item.QuantidadeTotalMedida;
                var valorPendente = item.Valor - item.ValorTotalMedido;

                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronogramaId)').val(item.ContratoRetificacaoItemCronogramaId);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialCronograma)').val(item.ContratoRetificacaoItemCronograma.Sequencial);

                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.ValorPendente)').val(roundDecimal(floatToString(valorPendente), 2));
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.QuantidadePendente)").val(roundDecimal(floatToString(quantidadePendente), 7));

                var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val(dataEmissao);
                if (!validaDataVencimento()){
                    return;
                }

                $("#@Html.IdFor(m => m.PrecoUnitario)").val(roundDecimal(floatToString(precoUnitario), 5));

                if (ehNaturezaItemPorPrecoGlobal) {
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Quantidade)").val(roundDecimal(floatToString(1), 7));
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(1), 7));
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').prop('readonly', true);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').prop('readonly', false);

                    document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').className = "text-right decimal-2-casas required";
                    document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').className = "text-right decimal-7-casas readonly";

                }
                else {
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Quantidade)").val(roundDecimal(floatToString(item.ContratoRetificacaoItemCronograma.Quantidade), 7));
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(quantidadePendente), 7));
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').prop('readonly', false);
                    $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').prop('readonly', true);

                    document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').className = "text-right decimal-2-casas readonly";
                    document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').className = "text-right decimal-7-casas required";
                }
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Valor)").val(roundDecimal(floatToString(item.ContratoRetificacaoItemCronograma.Valor), 2));
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(valorPendente), 2));
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(roundDecimal(floatToString(0), 2));
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Observacao)").val("");
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto)").val("");

                $("#@Html.IdFor(m => m.EhSituacaoAguardandoAprovacao)").val(true);
                $("#@Html.IdFor(m => m.EhSituacaoAguardandoLiberacao)").val(false);
                $("#@Html.IdFor(m => m.EhSituacaoLiberado)").val(false);

                tratarBotoes(true, false, false);

                setarAbaMedicao();
            }
        }
    }

    function tratarBotoes(condicaoSalvar, condicaoCancelar, condicaoImprimir) {
        $("#@Html.IdFor(m => m.PodeSalvar)").val(condicaoSalvar);
        $("#@Html.IdFor(m => m.PodeCancelar)").val(condicaoCancelar);
        $("#@Html.IdFor(m => m.PodeImprimir)").val(condicaoImprimir);

        if (condicaoSalvar) {
            document.getElementById('btnSalvar').className = "btn btn-primary right";
        }
        else {
            document.getElementById('btnSalvar').className = "btn btn-primary right disabled";
        }
        if (condicaoCancelar) {
            document.getElementById('btnCancelar').className = "btn btn-danger";
        }
        else {
            document.getElementById('btnCancelar').className = "btn btn-danger disabled";
        }
        if (condicaoImprimir) {
            document.getElementById('btnImprimir').className = "btn btn-primary";

        }
        else {
            document.getElementById('btnImprimir').className = "btn btn-primary disabled";
        }
    }

    function limpaAbaDadosMedicao() {
        var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val(dataEmissao);
        $("#@Html.IdFor(m => m.PrecoUnitario)").val(roundDecimal(floatToString(0), 5));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Quantidade)").val(roundDecimal(floatToString(0), 7));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(0), 7));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Valor)").val(roundDecimal(floatToString(0), 2));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(0), 2));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(roundDecimal(floatToString(0), 2));
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Observacao)").val("");
        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto)").val("");

        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronogramaId)').val(0);
        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialCronograma)').val(0);
        $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)').val(null);

        tratarBotoes(false, false, false);
    }

    function setarAbaProvisionamento() {
        $('#AbaProvisionamentoId').click();
    }

    function setarAbaMedicao() {
        $('#AbaMedicaoId').click();
    }

    function validaNumeroDocumento() {
        var isValid = false;
        var contratadoId = $("#@Html.IdFor(m => m.Contrato.ContratadoId)").val();
        var multiFornecedorId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId)").val();
        var dataEmissao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val();
        var numeroDocumento = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").val();

        //if (multiFornecedorId != "") {
        //    contratadoId = multiFornecedorId;
        //}

        $.ajax({
            type: 'POST',
            url: '@Url.Action("ExisteNumeroDocumento", "MedicaoContrato", new { area = "Contrato" })',
            cache: false,
            async: false,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({
                dataEmissao: dataEmissao,
                numeroDocumento: numeroDocumento,
                contratadoId: contratadoId,
                multiFornecedorId: multiFornecedorId
            })
        })
        .success(function (result) {
            existeNumeroDocumento = result.existe;
        })
        .error(function (result) {
            smartAlert("Erro", "Ocorreu erro na validação do número do documento", "error");
            existeNumeroDocumento = false;
        });

        if (existeNumeroDocumento) {
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").val("");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").focus();
            smartAlert("Atenção", "Documento existente no contrato.", "warning");
        }

        isValid = !existeNumeroDocumento;

        return isValid;

    }

    function validaDataVencimento() {
        var dataVencimento = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)").val();
        var dataMedicao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val();

        if ((dataMedicao != "") && (dataVencimento != "")) {
            if (compararDatas(dataMedicao,dataVencimento) > 0){
                smartAlert("Atenção", "Data de medição maior que data de vencimento !", "warning");
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val(dataVencimento);
                return false;
            }

            var ehSituacaoMedicaoAguardandoAprovacao = ($("#@Html.IdFor(m => m.EhSituacaoAguardandoAprovacao)").val() === "true");
            var ehSituacaoMedicaoAguardandoLiberacao = ($("#@Html.IdFor(m => m.EhSituacaoAguardandoLiberacao)").val() === "true");

            var diasPagamentoParametrosContrato = $("#@Html.IdFor(m => m.DiasPagamentoParametrosContrato)").val();

            if ((ehSituacaoMedicaoAguardandoAprovacao || ehSituacaoMedicaoAguardandoLiberacao) && (diasPagamentoParametrosContrato > 0)) {
                var numeroDias = diasDecorridos(dataMedicao,dataVencimento);
                if (numeroDias < diasPagamentoParametrosContrato) {
                    smartAlert("Atenção", "Data de vencimento fora do limite de pagamento !", "warning");
                    return false;
                }
            }
        }

        return true;
    }

    function validaDataMedicao() {
        var dataMedicao = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val();

        if (!validaDataVencimento()) {
            return false;
        }

        if ((dataMedicao != "")) {

            var ehSituacaoMedicaoAguardandoAprovacao = ($("#@Html.IdFor(m => m.EhSituacaoAguardandoAprovacao)").val() === "true");
            var ehSituacaoMedicaoAguardandoLiberacao = ($("#@Html.IdFor(m => m.EhSituacaoAguardandoLiberacao)").val() === "true");

            var dataLimiteMedicao = $("#@Html.IdFor(m => m.DataLimiteMedicao)").val();

            if ((ehSituacaoMedicaoAguardandoAprovacao || ehSituacaoMedicaoAguardandoLiberacao) && (dataLimiteMedicao != "")) {
                if (compararDatas(dataMedicao, dataLimiteMedicao) < 0) {
                    smartAlert("Atenção", "Data de medição menor que data limite !", "warning");
                    $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val("");
                    return false;
                }
            }
        }

        return true;
    }

    function validaValorMedicaoAtual() {
        var valorMedido = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val());
        var valorPendente = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.ValorPendente)").val());
        var precoUnitario = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val()); 
        var desconto = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val()); 
        var quantidadeMedicao = 0;

        if (isNaN(valorMedido)) valorMedido = 0;
        if (isNaN(valorPendente)) valorPendente = 0;
        if (isNaN(precoUnitario)) precoUnitario = 0;
        if (isNaN(desconto)) desconto = 0;

        if (valorMedido == 0)  {
            smartAlert("Atenção", "Valor medido não pode ser zerado !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(valorPendente), 2));
            return false;
        }

        if (valorMedido > valorPendente) {
            smartAlert("Atenção", "Valor medido maior que valor pendente !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(valorPendente), 2));
            return false;
        }

        if (valorMedido <= desconto) {
            smartAlert("Atenção", "Valor medido menor que o valor do desconto !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(valorPendente), 2));
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(roundDecimal(0, 2));
            return false;
        }

        var ehNaturezaItemGenericoPorPrecoGlobal = ($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)").val() === "true");
        if (!ehNaturezaItemGenericoPorPrecoGlobal)
        {
            quantidadeMedicao = valorMedido / precoUnitario;
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(quantidadeMedicao), 7));
        }

        return true;
    }

    function validaQuantidadeMedicaoAtual() {
        var quantidadeMedida = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val());
        var quantidadePendente = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.QuantidadePendente)").val());
        var precoUnitario = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)").val());
        var desconto = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val());
        var valorMedido = 0;

        if (isNaN(quantidadeMedida)) quantidadeMedida = 0;
        if (isNaN(quantidadePendente)) quantidadePendente = 0;
        if (isNaN(precoUnitario)) precoUnitario = 0;
        if (isNaN(desconto)) desconto = 0;

        if (quantidadeMedida == 0) {
            smartAlert("Atenção", "A quantidade medida não pode ser zero!", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(quantidadePendente), 7));
            return false;
        }

        if (quantidadeMedida > quantidadePendente) {
            smartAlert("Atenção", "Quantidade medida maior que quantidade pendente !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(roundDecimal(floatToString(quantidadePendente), 7));
            return false;
        }

        valorMedido = quantidadeMedida * precoUnitario;

        $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(roundDecimal(floatToString(valorMedido), 2));

        if (valorMedido <= desconto) {
            smartAlert("Atenção", "Valor medido menor que o valor do desconto !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(roundDecimal(0, 2));
            return false;
        }

        return true;
    }

    function validaDesconto() {
        var desconto = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val());
        var valorMedido = stringToFloat($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val());

        if (isNaN(valorMedido)) valorMedido = 0;
        if (isNaN(desconto)) desconto = 0;

        if (valorMedido == 0) {
            smartAlert("Atenção", "O valor medido não pode ser zero !", "warning");
            return false;
        }

        if (valorMedido <= desconto) {
            smartAlert("Atenção", "Valor medido menor que o valor do desconto !", "warning");
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(roundDecimal(0, 2));
            return false;
        }

        return true;
    }

    function preencheLstMedicao() {
        $("#tableLstMedicao thead").empty();
        var row = $('<tr role="row">');
        $("#tableLstMedicao thead").append(row);
        row.append($('<th class="text-center" style="min-width: 65px;">Data</th>'));
        row.append($('<th class="text-left">Tipo Doc.</th>'));
        row.append($('<th class="text-left">No doc.</th>'));
        row.append($('<th class="text-right">Valor</th>'));
        row.append($('<th class="text-right">Valor retido</th>'));
        row.append($('<tr />'));

        $("#tableLstMedicao tbody").empty();

        if (jsonContratoRetificaoItemMedicaoArray != null) {
            for (var i = 0; i < jsonContratoRetificaoItemMedicaoArray.length; i++) {

                var row = $('<tr />')

                $("#tableLstMedicao tbody").append(row);
                row.append($('<td class="text-center text-nowrap" data-dismiss="modal" onclick="recuperaDadosMedicao(' + jsonContratoRetificaoItemMedicaoArray[i].Id + ');">' + new Date(parseInt(jsonContratoRetificaoItemMedicaoArray[i].DataMedicao.substr(6))).toFormatDDMMYYYY() + '</td>'));
                row.append($('<td class="text-left text-nowrap">' + jsonContratoRetificaoItemMedicaoArray[i].TipoDocumento.Sigla + '</td>'));
                row.append($('<td class="text-left">' + jsonContratoRetificaoItemMedicaoArray[i].NumeroDocumento + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonContratoRetificaoItemMedicaoArray[i].Valor), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonContratoRetificaoItemMedicaoArray[i].ValorRetido), 2) + '</td>'));
            }

            var row = $('<tr />')

            setarAbaMedicao();
        }
    }

    function recuperaDadosMedicao(ContratoRetificacaoItemMedicaoId) {
        var contratoId = $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoId)").val();
        var isRecuperou = false;
        $.ajax({
            type: 'POST',
            url: '@Url.Action("RecuperaContratoRetificacaoItemMedicao", "MedicaoContrato", new { Area = "Contrato" })',
            cache: false,
            async: false,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({
                contratoId: contratoId,
                contratoRetificacaoItemMedicaoId: ContratoRetificacaoItemMedicaoId
            }),
            success: function (result) {
                if (result.ehRecuperou) {
                    jsonMedicao = result.medicaoRecuperada;
                    carregaAbaDadosMedicaoPesquisa();
                    jsonMedicao = null;
                }
                isRecuperou = result.ehRecuperou;
            },
            error: function (result) {
                smartAlert("Atenção", result.errorMessage, "warning");
            }
        });

        return isRecuperou;
    }

    function carregaAbaDadosMedicaoPesquisa() {
        var ehNaturezaItemPorPrecoGlobal = ($("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.EhNaturezaItemGenericoPorPrecoGlobal)").val() === "true");

        limpaAbaDadosMedicao();

        if (jsonMedicao != null) {
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Id)").val(jsonMedicao.Id);
            $("#@Html.IdFor(m => m.EhSituacaoAguardandoAprovacao)").val(false);
            $("#@Html.IdFor(m => m.EhSituacaoAguardandoLiberacao)").val(false);
            $("#@Html.IdFor(m => m.EhSituacaoLiberado)").val(false);
            if (jsonMedicao.Situacao == 0) {
                $("#@Html.IdFor(m => m.EhSituacaoAguardandoAprovacao)").val(true);
                tratarBotoes(true, true, true);
            }
            else if (jsonMedicao.Situacao == 1) {
                $("#@Html.IdFor(m => m.EhSituacaoAguardandoLiberacao)").val(true);
                tratarBotoes(true, true, true);
            }
            else if (jsonMedicao.Situacao == 2) {
                $("#@Html.IdFor(m => m.EhSituacaoLiberado)").val(true);
                tratarBotoes(false, false, true);
            }
            else {
                tratarBotoes(false, false, true);
            }
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.TipoDocumentoId)").val(jsonMedicao.TipoDocumentoId);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NumeroDocumento)").val(jsonMedicao.NumeroDocumento);
            var dataEmissao = new Date(parseInt(jsonMedicao.DataEmissao.substr(6))).toFormatDDMMYYYY();
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataEmissao)").val(dataEmissao);
            var dataVencimento = new Date(parseInt(jsonMedicao.DataVencimento.substr(6))).toFormatDDMMYYYY();
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataVencimento)").val(dataVencimento);
            if (jsonMedicao.MultiFornecedorId != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MultiFornecedorId)").val(jsonMedicao.MultiFornecedorId);
            }
            if (jsonMedicao.TipoCompraCodigo != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.TipoCompraCodigo)").val(jsonMedicao.TipoCompraCodigo);
            }
            if (jsonMedicao.CifFobId != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.CifFobId)").val(jsonMedicao.CifFobId);
            }
            if (jsonMedicao.NaturezaOperacaoCodigo != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.NaturezaOperacaoCodigo)").val(jsonMedicao.NaturezaOperacaoCodigo);
            }
            if (jsonMedicao.SerieNFId != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SerieNFId)").val(jsonMedicao.SerieNFId);
            }
            if (jsonMedicao.CSTCodigo != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.CSTCodigo)").val(jsonMedicao.CSTCodigo);
            }
            if (jsonMedicao.CodigoContribuicaoCodigo != null) {
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.CodigoContribuicaoCodigo)").val(jsonMedicao.CodigoContribuicaoCodigo);
            }
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.CodigoBarras)").val(jsonMedicao.CodigoBarras);

            var dataMedicao = new Date(parseInt(jsonMedicao.DataMedicao.substr(6))).toFormatDDMMYYYY();
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.DataMedicao)").val(dataMedicao);

            var valor = roundDecimal(floatToString(jsonMedicao.Valor), 2);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)").val(valor);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.ValorPendente)").val(valor);

            var quantidade = roundDecimal(floatToString(jsonMedicao.Quantidade), 7);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)").val(quantidade);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Totalizadores.QuantidadePendente)").val(quantidade);

            if (jsonMedicao.Desconto != null) {
                var desconto = roundDecimal(floatToString(jsonMedicao.Desconto), 2);
                $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Desconto)").val(desconto);
            }

            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.MotivoDesconto)").val(jsonMedicao.MotivoDesconto);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Observacao)").val(jsonMedicao.Observacao);

            $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronogramaId)').val(jsonMedicao.ContratoRetificacaoItemCronogramaId);
            $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.SequencialCronograma)').val(jsonMedicao.ContratoRetificacaoItemCronograma.Sequencial);
         
            var precoUnitario = $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItem.PrecoUnitario)').val();
            $('#@Html.IdFor(m => m.PrecoUnitario)').val(precoUnitario);           

            if (ehNaturezaItemPorPrecoGlobal) {
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').prop('readonly', true);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').prop('readonly', false);

                document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').className = "text-right decimal-2-casas required";
                document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').className = "text-right decimal-7-casas readonly";
            }
            else {
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').prop('readonly', false);
                $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').prop('readonly', true);

                document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Valor)').className = "text-right decimal-2-casas readonly";
                document.getElementById('@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.Quantidade)').className = "text-right decimal-7-casas required";
            }

            var valorItemCronograma = roundDecimal(floatToString(jsonMedicao.ContratoRetificacaoItemCronograma.Valor), 2);
            $('#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Valor)').val(valorItemCronograma);

            var quantidadeItemCronograma = roundDecimal(floatToString(jsonMedicao.ContratoRetificacaoItemCronograma.Quantidade), 7);
            $("#@Html.IdFor(m => m.ContratoRetificacaoItemMedicao.ContratoRetificacaoItemCronograma.Quantidade)").val(quantidadeItemCronograma);

            setarAbaMedicao();

        }
    }

    function preencheLstVisualizacaoMedicao() {
        $("#tableLstVisMedicao thead").empty();
        var row = $('<tr role="row">');
        $("#tableLstVisMedicao thead").append(row);
        row.append($('<th class="text-left" style="min-width: 65px;">Item</th>'));
        row.append($('<th class="text-left">Descrição item</th>'));
        row.append($('<th class="text-center">Medição</th>'));
        row.append($('<th class="text-right">Quantidade</th>'));
        row.append($('<th class="text-right">Valor unitário</th>'));
        row.append($('<th class="text-right">Valor bruto</th>'));
        row.append($('<th class="text-right">Valor liberado</th>'));
        row.append($('<th class="text-right">Valor retido</th>'));
        row.append($('<th class="text-right">Valor imposto</th>'));
        row.append($('<th class="text-right">Valor desconto</th>'));
        row.append($('<th class="text-right">Valor liquido</th>'));
        row.append($('<th class="text-right">Título</th>'));
        row.append($('<tr />'));

        $("#tableLstVisMedicao tbody").empty();

        var totalValor = 0;
        var totalValorLiberado = 0;
        var totalValorRetido = 0;
        var totalValorImposto = 0;
        var totalValorLiquido = 0;


        if (jsonContratoRetificaoItemMedicaoArray != null) {
            for (var i = 0; i < jsonContratoRetificaoItemMedicaoArray.length; i++) {

                var row = $('<tr />')
                var descricaoItem = jsonContratoRetificaoItemMedicaoArray[i].ContratoRetificacaoItem.Servico.Descricao;
                var complementoDescricaoItem = jsonContratoRetificaoItemMedicaoArray[i].ContratoRetificacaoItem.ComplementoDescricao;
                if (complementoDescricaoItem != "") descricaoItem = descricaoItem + " (" + complementoDescricaoItem + ")";
                var dataMedicao = new Date(parseInt(jsonContratoRetificaoItemMedicaoArray[i].DataMedicao.substr(6))).toFormatDDMMYYYY();
                var valorUnitario = 0;
                if (jsonContratoRetificaoItemMedicaoArray[i].ContratoRetificacaoItem.NaturezaItem == 1) {
                    valorUnitario = jsonContratoRetificaoItemMedicaoArray[i].Valor;
                }
                else {
                    valorUnitario = jsonContratoRetificaoItemMedicaoArray[i].ContratoRetificacaoItem.PrecoUnitario;
                }
                var valor = jsonContratoRetificaoItemMedicaoArray[i].Valor;
                totalValor = totalValor + valor;
                var valorRetido = jsonContratoRetificaoItemMedicaoArray[i].ValorRetido;
                var valorLiberado = valor;
                if (!isNaN(valorRetido && valorRetido != null) ) {
                    valorLiberado = valor - valorRetido;
                }
                else {
                    valorRetido = 0;
                }
                totalValorLiberado = totalValorLiberado + valorLiberado;
                totalValorRetido = totalValorRetido + valorRetido;

                var valorImpostoRetido = jsonContratoRetificaoItemMedicaoArray[i].ValorImpostoRetidoMedicao;
                var valorImpostoIndireto = jsonContratoRetificaoItemMedicaoArray[i].ValorImpostoIndiretoMedicao;
                var valorTotalMedidoIndireto = jsonContratoRetificaoItemMedicaoArray[i].ValorTotalMedidoIndireto;
                if (valorTotalMedidoIndireto < 5000.0) valorImpostoIndireto = 0;

                var valorImposto = 0;
                var valorLiquido = 0;

                if (valorImpostoRetido > 0 || valorImpostoIndireto > 0) {
                    valorImposto = valorImpostoIndireto + valorImpostoRetido;
                    totalValorImposto = totalValorImposto + valorImposto;
                    valorLiquido = valorLiberado - valorImposto;
                }
                else {
                    valorLiquido = valorLiberado;
                }
                totalValorLiquido = totalValorLiquido + valorLiquido;

                var valorDesconto = jsonContratoRetificaoItemMedicaoArray[i].Desconto;
                if (isNaN(valorDesconto) || valorDesconto == null) {
                    valorDesconto = 0;
                }
                valorLiquido = valorLiberado - valorDesconto;

                var titulo = "";
                var tituloPagar = "";
                var tituloReceber = "";
                var tipoContrato = $("#@Html.IdFor(m => m.Contrato.TipoContrato)").val();
                if (tipoContrato == 1) {
                    tituloReceber = jsonContratoRetificaoItemMedicaoArray[i].TituloReceberId;
                    if ((tituloReceber!= null)&&!isNaN(tituloReceber)) titulo = tituloReceber;
                }
                else {
                    tituloPagar = jsonContratoRetificaoItemMedicaoArray[i].TituloPagarId;
                    if ((tituloPagar != null) && !isNaN(tituloPagar)) titulo = tituloPagar;
                }

                $("#tableLstVisMedicao tbody").append(row);
                row.append($('<td class="text-left">' + jsonContratoRetificaoItemMedicaoArray[i].SequencialItem + '</td>'));
                row.append($('<td class="text-left text-nowrap">' + descricaoItem + '</td>'));
                row.append($('<td class="text-center">' + dataMedicao + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(jsonContratoRetificaoItemMedicaoArray[i].Quantidade), 7) + '</td>'));               
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorUnitario), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valor), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorLiberado), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorRetido), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorImposto), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorDesconto), 2) + '</td>'));
                row.append($('<td class="text-right">' + roundDecimal(floatToString(valorLiquido), 2) + '</td>'));
                row.append($('<td class="text-right">' + titulo + '</td>'));
            }

            var row = $('<tr />')

            $("#tableLstVisMedicao tbody").append(row);
            row.append($('<td>Totais</td>'));
            row.append($('<td></td>'));
            row.append($('<td></td>'));
            row.append($('<td></td>'));
            row.append($('<td></td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValor), 2) + '</td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorLiberado), 2) + '</td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorRetido), 2) + '</td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorImposto), 2) + '</td>'));
            row.append($('<td></td>'));
            row.append($('<td class="text-right">' + roundDecimal(floatToString(totalValorLiquido), 2) + '</td>'));
            row.append($('<td></td>'));

            var row = $('<tr />')
            $("#tableLstVisMedicao tbody").append(row);
        }
    }

</script>